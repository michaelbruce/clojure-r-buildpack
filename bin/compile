#!/usr/bin/env bash

set -e

echo "Machine information: $(uname -a)"

BUILD_DIR=$1
CACHE_DIR="$2/vendor"
VENDOR_DIR="$BUILD_DIR/vendor"
LP_DIR=`cd $(dirname $0); cd ..; pwd`
BUILDPACK_DIR="$(dirname $(dirname $0))"
[ -z "${CRAN_MIRROR}" ] && CRAN_MIRROR="http://cloud.r-project.org"

echo $BUILD_DIR
echo $CACHE_DIR

mkdir -p $CACHE_DIR
mkdir -p $VENDOR_DIR

# Building wkhtmltopdf

TMP_PATH="$BUILD_DIR/tmp"
BIN_PATH="$BUILD_DIR/bin"

mkdir -p $BIN_PATH $TMP_PATH

WKHTMLTOPDF_URL="https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.5/wkhtmltox_0.12.5-1.xenial_amd64.deb"
WKHTMLTOPDF_DEB="$CACHE_DIR/wkhtmltox_0.12.5-1.xenial_amd64.deb"

if [ -f $WKHTMLTOPDF_DEB ]; then
  echo "-----> Using wkhtmltopdf deb from cache"
else
  echo "-----> Downloading wkhtmltopdf deb"
  curl -L $WKHTMLTOPDF_URL -o $WKHTMLTOPDF_DEB
fi

echo "-----> Installing wkhtmltopdf"
sudo dpkg -i $WKHTMLTOPDF_TAR

# Building ghostscript

echo "-----> Installing Ghostscript 9.20 using build directory $1"

PACKAGE="https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs921/ghostscript-9.21-linux-x86_64.tgz"
BINARY="ghostscript-9.21-linux-x86_64/gs-921-linux-x86_64"
LOCATION="$BUILD_DIR/vendor/gs"

cd $BUILD_DIR
mkdir -p $LOCATION/bin
wget -O gs.tgz $PACKAGE # Couldn't get curl to work for some reason
tar xvf gs.tgz
mv $BINARY $LOCATION/bin/gs

echo "-----> Building runtime environment for Ghostscript to $LOCATION"

mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"\$HOME/vendor/gs/bin:\$PATH\"" > $BUILD_DIR/.profile.d/ghostscript.sh

echo "-----> Downloading and unpacking R binaries..."
# updates can be found here https://heroku-buildpack-r.s3.amazonaws.com/
R_BINARIES="https://s3-eu-west-1.amazonaws.com/sbsl-buildpack-resources/R-3.4.3-runtime.tar.gz"
rm -rf $VENDOR_DIR/R && mkdir -p $VENDOR_DIR/R
curl $R_BINARIES -s -o - | tar xzf - -C $VENDOR_DIR/R

echo "Contents of $VENDOR_DIR"
ls $VENDOR_DIR

export PATH="$VENDOR_DIR/R/bin:$VENDOR_DIR/wkhtmltopdf:/app/.apt/usr/bin:$PATH"
export LD_LIBRARY_PATH="/app/.apt/usr/lib/libblas:/app/.apt/usr/lib/lapack:/app/.apt/usr/lib/x86_64-linux-gnu:/app/.apt/usr/lib/i386-linux-gnu:/app/.apt/usr/lib:$LD_LIBRARY_PATH"
export LIBRARY_PATH="/app/.apt/usr/lib/x86_64-linux-gnu:/app/.apt/usr/lib/i386-linux-gnu:/app/.apt/usr/lib:$LIBRARY_PATH"
export INCLUDE_PATH="/app/.apt/usr/include:$INCLUDE_PATH"
export CPATH="$INCLUDE_PATH"
export CPPPATH="$INCLUDE_PATH"
export PKG_CONFIG_PATH="/app/.apt/usr/lib/x86_64-linux-gnu/pkgconfig:/app/.apt/usr/lib/i386-linux-gnu/pkgconfig:/app/.apt/usr/lib/pkgconfig:$PKG_CONFIG_PATH"
export LDFLAGS="-L/app/.apt/usr/lib/libblas -L/app/.apt/usr/lib/lapack $LDFLAGS"

# copy over environment
mkdir -p $BUILD_DIR/.profile.d
cp "$BUILDPACK_DIR/bin/r_environment.sh" $BUILD_DIR/.profile.d/r_environment.sh

# Building Java binary

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
. $BIN_DIR/java
. $BIN_DIR/util

# Install JDK
install_java_with_overlay ${BUILD_DIR}

java -version

echo "JAVA_OPTS: $JAVA_OPTS"

# Printing diagnostic information

export PATH="$BUILD_DIR:$CACHE_DIR:$PATH"

echo $PATH
